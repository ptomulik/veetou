PRAGMA temp_store = 2;

CREATE TEMP VIEW job_uuid AS
  SELECT value
  FROM ko_variables
  WHERE name = 'job_uuid'
;

CREATE TEMP TABLE table_decls (table_name, table_id, field_list);
INSERT INTO table_decls VALUES(
  'ko_jobs',
  'D01',
  '(
      tab_id FILLER CHAR
    , job_uuid CHAR
    , job_timestamp TIMESTAMP ''YYYY-MM-DD HH24-MI-SS''
    , job_host CHAR
    , job_user CHAR
    , job_name CHAR
    )'
);

INSERT INTO table_decls VALUES(
    'ko_footers',
    'D02',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , pagination CHAR
    , sheet_page_number INTEGER EXTERNAL
    , sheet_pages_total INTEGER EXTERNAL
    , generator_name CHAR
    , generator_home CHAR
    )'
);

INSERT INTO table_decls VALUES(
    'ko_headers',
    'D03',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , university CHAR
    , faculty CHAR
    )'
);

INSERT INTO table_decls VALUES(
    'ko_pages',
    'D04',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , page_number INTEGER EXTERNAL
    , parser_page_number INTEGER EXTERNAL
    )'
);
INSERT INTO table_decls VALUES(
    'ko_preambles',
    'D05',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , studies_modetier CHAR
    , title CHAR
    , student_index CHAR
    , first_name CHAR
    , last_name CHAR
    , student_name CHAR
    , semester_code CHAR
    , studies_field CHAR
    , semester_number INTEGER EXTERNAL
    , studies_specialty CHAR
    )'
);

INSERT INTO table_decls VALUES(
    'ko_reports',
    'D06',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , source CHAR
    , datetime TIMESTAMP ''YYYY-MM-DD HH24-MI-SS''
    , first_page INTEGER EXTERNAL
    , sheets_parsed INTEGER EXTERNAL
    , pages_parsed INTEGER EXTERNAL
    )'
);

INSERT INTO table_decls VALUES(
    'ko_sheets',
    'D07',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , pages_parsed INTEGER EXTERNAL
    , first_page INTEGER EXTERNAL
    , ects_mandatory INTEGER EXTERNAL
    , ects_other INTEGER EXTERNAL
    , ects_total INTEGER EXTERNAL
    , ects_attained INTEGER EXTERNAL
    )'
);

INSERT INTO table_decls VALUES(
    'ko_tbodies',
    'D08',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , remark CHAR
    )'
);

INSERT INTO table_decls VALUES(
    'ko_trs',
    'D09',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , id INTEGER EXTERNAL
    , subj_code CHAR
    , subj_name CHAR
    , subj_hours_w INTEGER EXTERNAL
    , subj_hours_c INTEGER EXTERNAL
    , subj_hours_l INTEGER EXTERNAL
    , subj_hours_p INTEGER EXTERNAL
    , subj_hours_s INTEGER EXTERNAL
    , subj_credit_kind CHAR
    , subj_ects INTEGER EXTERNAL
    , subj_tutor CHAR
    , subj_grade CHAR
    , subj_grade_date DATE ''YYYY-MM-DD''
    )'
);

INSERT INTO table_decls VALUES(
    'ko_page_footer_j',
    'J01',
    '(
        tab_id FILLER POSITION(1) CHAR
      , job_uuid CHAR
      , ko_page_id INTEGER EXTERNAL
      , ko_footer_id INTEGER EXTERNAL
      )'
);

INSERT INTO table_decls VALUES(
    'ko_page_header_j',
    'J02',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , ko_page_id INTEGER EXTERNAL
    , ko_header_id INTEGER EXTERNAL
    )'
);

INSERT INTO table_decls VALUES(
    'ko_page_preamble_j',
    'J03',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , ko_page_id INTEGER EXTERNAL
    , ko_preamble_id INTEGER EXTERNAL
    )'
);

INSERT INTO table_decls VALUES(
    'ko_page_tbody_j',
    'J04',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , ko_page_id INTEGER EXTERNAL
    , ko_tbody_id INTEGER EXTERNAL
    )'
);

INSERT INTO table_decls VALUES(
    'ko_report_sheets_j',
    'J05',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , ko_report_id INTEGER EXTERNAL
    , ko_sheet_id INTEGER EXTERNAL
    )'
);

INSERT INTO table_decls VALUES(
    'ko_sheet_pages_j',
    'J06',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , ko_sheet_id INTEGER EXTERNAL
    , ko_page_id INTEGER EXTERNAL
    )'
);

INSERT INTO table_decls VALUES(
    'ko_tbody_trs_j',
    'J07',
    '(
      tab_id FILLER POSITION(1) CHAR
    , job_uuid CHAR
    , ko_tbody_id INTEGER EXTERNAL
    , ko_tr_id INTEGER EXTERNAL
    )'
);

CREATE TEMP VIEW table_decl_strings AS
  SELECT
    table_name, ('
    INTO TABLE v2u_' || table_name || '
    WHEN tab_id = ''' || table_id || '''
    FIELDS TERMINATED BY ";" OPTIONALLY ENCLOSED BY ''"''
    TRAILING NULLCOLS ' ||
    field_list)
  AS decl
  FROM table_decls
;

--
-- TABLE IMPORT LAYOUT
--

.mode list

SELECT 'LOAD DATA
    CHARACTERSET UTF8
    LENGTH SEMANTICS CHAR
    INFILE *
    APPEND
';

SELECT decl FROM table_decl_strings WHERE table_name='ko_jobs';
SELECT decl FROM table_decl_strings WHERE table_name='ko_footers';
SELECT decl FROM table_decl_strings WHERE table_name='ko_headers';
SELECT decl FROM table_decl_strings WHERE table_name='ko_pages';
SELECT decl FROM table_decl_strings WHERE table_name='ko_preambles';
SELECT decl FROM table_decl_strings WHERE table_name='ko_reports';
SELECT decl FROM table_decl_strings WHERE table_name='ko_sheets';
SELECT decl FROM table_decl_strings WHERE table_name='ko_tbodies';
SELECT decl FROM table_decl_strings WHERE table_name='ko_trs';
SELECT decl FROM table_decl_strings WHERE table_name='ko_page_footer_j';
SELECT decl FROM table_decl_strings WHERE table_name='ko_page_header_j';
SELECT decl FROM table_decl_strings WHERE table_name='ko_page_preamble_j';
SELECT decl FROM table_decl_strings WHERE table_name='ko_page_tbody_j';
SELECT decl FROM table_decl_strings WHERE table_name='ko_report_sheets_j';
SELECT decl FROM table_decl_strings WHERE table_name='ko_sheet_pages_j';
SELECT decl FROM table_decl_strings WHERE table_name='ko_tbody_trs_j';

SELECT '';
SELECT 'BEGINDATA';

--
-- TABLE DATA
--


.mode csv
.header off
.separator ";" "\n"

----------- ko_jobs
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_jobs') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , (SELECT value FROM ko_variables WHERE name = 'job_timestamp') AS job_timestamp
  , (SELECT value FROM ko_variables WHERE name = 'job_host') AS job_host
  , (SELECT value FROM ko_variables WHERE name = 'job_user') AS job_user
  , (SELECT value FROM ko_variables WHERE name = 'job_name') AS job_name
;

----------- ko_footers
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_footers') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_footers.*
FROM ko_footers;

----------- ko_headers
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_headers') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_headers.*
FROM ko_headers;

----------- ko_pages
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_pages') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_pages.*
FROM ko_pages;

----------- ko_preambles
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_preambles') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_preambles.*
FROM ko_preambles;

----------- ko_reports
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_reports') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_reports.*
FROM ko_reports;

----------- ko_sheets
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_sheets') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_sheets.*
FROM ko_sheets;

----------- ko_tbodies
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_tbodies') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_tbodies.*
FROM ko_tbodies;

----------- ko_trs
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_trs') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_trs.*
FROM ko_trs;


--
-- JUNCTION TABLES
--


----------- ko_page_footer
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_page_footer_j') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_page_footer.*
FROM ko_page_footer;

----------- ko_page_header
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_page_header_j') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_page_header.*
FROM ko_page_header;

----------- ko_page_preamble
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_page_preamble_j') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_page_preamble.*
FROM ko_page_preamble;

----------- ko_page_tbody
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_page_tbody_j') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_page_tbody.*
FROM ko_page_tbody;

----------- ko_report_sheets
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_report_sheets_j') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_report_sheets.*
FROM ko_report_sheets;

----------- ko_sheet_pages
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_sheet_pages_j') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_sheet_pages.*
FROM ko_sheet_pages;

----------- ko_tbody_trs
SELECT
    (SELECT table_id FROM table_decls WHERE table_name = 'ko_tbody_trs_j') AS table_id
  , (SELECT value FROM job_uuid) AS job_uuid
  , ko_tbody_trs.*
FROM ko_tbody_trs;


DROP VIEW job_uuid;
DROP VIEW table_decl_strings;
DROP TABLE table_decls;

-- vim: set ft=sql:
